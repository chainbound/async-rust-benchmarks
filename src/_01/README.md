# 01: `Future` implementation vs. `tokio::select!` loop for actors

- [Overview](#overview)
- [Results](#results)

## Overview
This benchmark compares the performance of a `Future` implementation vs. a `tokio::select!` loop for long-running actors.
The basic flow looks like this:

```mermaid
graph TD
    A["Client"] --> B["Task Channel<br/>(mpsc::Receiver)"]
    B --> C["Actor<br/>(Future vs tokio::select!)"]
    C --> D["Processing Tasks<br/>(FuturesUnordered)"]
    C --> E["Results Channel<br/>(mpsc::Sender)"]
    E --> F["Client Results<br/>(mpsc::Receiver)"]
    
    style A fill:#e1f5fe
    style F fill:#e8f5e8
    style C fill:#fff3e0
    style D fill:#fce4ec
```

The workload is a simple task that is initialized with an input (`std::time::Instant`), adds 10 microseconds of delay (in the form of `tokio::time::sleep`), and returns the input. The input is also used to measure the processing latency of each task in the latency benchmark.

## Results
- Tasks: 50000
- Iterations: 100
- System: Apple M4 Pro, 10 Cores, 32GB RAM
- Command: `cargo bench 01`

### Latency
```
┌──────────────────────────┬──────────────┬────────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ actor_type               │ mean_latency │ median_latency │ min_latency │ max_latency │ p10_latency │ p90_latency │ p99_latency │
├──────────────────────────┼──────────────┼────────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ FutureActorUnconstrained │ 756.36µs     │ 732.33µs       │ 15.21µs     │ 2.88ms      │ 502.17µs    │ 1.00ms      │ 1.86ms      │
├──────────────────────────┼──────────────┼────────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ RandomSelectActor        │ 3.61ms       │ 3.87ms         │ 31.79µs     │ 8.72ms      │ 1.38ms      │ 5.35ms      │ 6.84ms      │
├──────────────────────────┼──────────────┼────────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ BiasedSelectActor        │ 3.77ms       │ 3.98ms         │ 18.71µs     │ 8.50ms      │ 1.15ms      │ 5.71ms      │ 7.31ms      │
├──────────────────────────┼──────────────┼────────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ FutureActor              │ 10.86ms      │ 10.03ms        │ 15.21µs     │ 27.25ms     │ 2.78ms      │ 20.16ms     │ 24.81ms     │
└──────────────────────────┴──────────────┴────────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```
### Throughput & Memory Usage
```
┌──────────────────────────┬───────────────┬─────────────────┬─────────────────┬───────────────────┬──────────────┬──────────────┬────────────────┬────────────────┬───────────────────┐
│ actor_type               │ mean_duration │ mean_throughput │ median_duration │ median_throughput │ min_duration │ max_duration │ min_throughput │ max_throughput │ max_pending_tasks │
├──────────────────────────┼───────────────┼─────────────────┼─────────────────┼───────────────────┼──────────────┼──────────────┼────────────────┼────────────────┼───────────────────┤
│ RandomSelectActor        │ 12.37ms       │ 4.070M          │ 11.97ms         │ 4.186M            │ 11.22ms      │ 19.49ms      │ 2.565M         │ 4.458M         │ 9984              │
├──────────────────────────┼───────────────┼─────────────────┼─────────────────┼───────────────────┼──────────────┼──────────────┼────────────────┼────────────────┼───────────────────┤
│ FutureActorUnconstrained │ 13.61ms       │ 3.678M          │ 13.69ms         │ 3.655M            │ 12.30ms      │ 14.37ms      │ 3.479M         │ 4.065M         │ 10304             │
├──────────────────────────┼───────────────┼─────────────────┼─────────────────┼───────────────────┼──────────────┼──────────────┼────────────────┼────────────────┼───────────────────┤
│ BiasedSelectActor        │ 14.01ms       │ 3.568M          │ 14.03ms         │ 3.565M            │ 13.54ms      │ 14.95ms      │ 3.344M         │ 3.692M         │ 12606             │
├──────────────────────────┼───────────────┼─────────────────┼─────────────────┼───────────────────┼──────────────┼──────────────┼────────────────┼────────────────┼───────────────────┤
│ FutureActor              │ 37.08ms       │ 1.359M          │ 37.25ms         │ 1.344M            │ 29.45ms      │ 49.50ms      │ 1.010M         │ 1.698M         │ 12772             │
└──────────────────────────┴───────────────┴─────────────────┴─────────────────┴───────────────────┴──────────────┴──────────────┴────────────────┴────────────────┴───────────────────┘
```

### Load (CPU)
```
┌──────────────────────────┬────────────────────────┬───────────────────┬─────────────────────┬───────────────────────┬──────────────────────────┬──────────────────┬─────────────────────┬───────────────────────┬──────────────────────────┬───────────────────────┬──────────────────────────┬─────────────────────────┬────────────────────────┬────────────────────────────┬───────────────────────────┐
│ actor_type               │ total_first_poll_delay │ total_idled_count │ total_idle_duration │ total_scheduled_count │ total_scheduled_duration │ total_poll_count │ total_poll_duration │ total_fast_poll_count │ total_fast_poll_duration │ total_slow_poll_count │ total_slow_poll_duration │ total_short_delay_count │ total_long_delay_count │ total_short_delay_duration │ total_long_delay_duration │
├──────────────────────────┼────────────────────────┼───────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼──────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼───────────────────────┼──────────────────────────┼─────────────────────────┼────────────────────────┼────────────────────────────┼───────────────────────────┤
│ RandomSelectActor        │ 5.08µs                 │ 81476             │ 100.90ms            │ 81642                 │ 450.26ms                 │ 81643            │ 670.99ms            │ 81463                 │ 656.07ms                 │ 180                   │ 14.92ms                  │ 81459                   │ 183                    │ 437.61ms                   │ 12.64ms                   │
├──────────────────────────┼────────────────────────┼───────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼──────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼───────────────────────┼──────────────────────────┼─────────────────────────┼────────────────────────┼────────────────────────────┼───────────────────────────┤
│ FutureActorUnconstrained │ 6.96µs                 │ 40428             │ 490.74ms            │ 40528                 │ 204.07ms                 │ 40529            │ 682.89ms            │ 39685                 │ 375.03ms                 │ 844                   │ 307.86ms                 │ 39874                   │ 654                    │ 150.56ms                   │ 53.51ms                   │
├──────────────────────────┼────────────────────────┼───────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼──────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼───────────────────────┼──────────────────────────┼─────────────────────────┼────────────────────────┼────────────────────────────┼───────────────────────────┤
│ BiasedSelectActor        │ 5.71µs                 │ 81578             │ 219.52ms            │ 82040                 │ 497.79ms                 │ 82041            │ 722.71ms            │ 81927                 │ 714.62ms                 │ 114                   │ 8.09ms                   │ 81428                   │ 612                    │ 447.46ms                   │ 50.33ms                   │
├──────────────────────────┼────────────────────────┼───────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼──────────────────┼─────────────────────┼───────────────────────┼──────────────────────────┼───────────────────────┼──────────────────────────┼─────────────────────────┼────────────────────────┼────────────────────────────┼───────────────────────────┤
│ FutureActor              │ 42.25µs                │ 79676             │ 204.28ms            │ 85712                 │ 1.62s                    │ 85713            │ 1.90s               │ 74243                 │ 1.12s                    │ 11470                 │ 775.14ms                 │ 73935                   │ 11777                  │ 824.60ms                   │ 792.41ms                  │
└──────────────────────────┴────────────────────────┴───────────────────┴─────────────────────┴───────────────────────┴──────────────────────────┴──────────────────┴─────────────────────┴───────────────────────┴──────────────────────────┴───────────────────────┴──────────────────────────┴─────────────────────────┴────────────────────────┴────────────────────────────┴───────────────────────────┘
```

## Notes
- Understand why `tokio::unconstrained` on the `FutureActor` is necessary to get the same performance as the `tokio::select!` loop.